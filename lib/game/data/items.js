///Fixed database of item data
itemDB = {
	pot_red:{
		name:"Red Potion",
		icon:"pot_red",
		desc:"A bottle containing red liquid",
		type:"Healing",
		stacks:true,
		maxStack:0,
		value: 100,
		rarity: 12,
		
		hp:100,
		
	},
	pot_redElixer:{
		name:"Red Elixer",
		icon:"pot_orange",
		desc:"A bottle containing bubbling red liquid",
		type:"Healing",
		stacks:true,
		maxStack:0,
		value: 100,
		rarity: 12,
		
		hp:1,
		
	},
	
	mat_copper:{
		name:"Chunk Copper",
		icon:"4",
		desc:"A rock chunk containing Copper.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:10,
		rarity:5,
	},
	mat_bronze:{
		name:"Chunk Bronze",
		icon:"4",
		desc:"Somehow, this rock chunk contains some Tin and Copper, already melted into bronze.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:20,
		rarity:10,
	},
	mat_iron:{
		name:"Chunk Iron",
		icon:"1",
		desc:"A rock chunk containing Iron.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:30,
		rarity:15,
	},
	mat_steel:{
		name:"Chunk Steel",
		icon:"3",
		desc:"Somehow, this chunk of rock contains Steel.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:40,
		rarity:20,
	},
	mat_frorium:{
		name:"Chunk Frorium",
		icon:"gem24",
		desc:"A chunk of rock with a bit of Frorium.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:50,
		rarity:25,
	},
	mat_preocium:{
		name:"Chunk Preocium",
		icon:"2",
		desc:"A rock chunk containing preocium.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:60,
		rarity:30,
	},
	mat_broedian:{
		name:"Chunk Preocium",
		icon:"8",
		desc:"A rock chunk containing broedian.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:70,
		rarity:35,
	},
	mat_mithril:{
		name:"Chunk Mithril",
		icon:"7",
		desc:"A rock chunk containing mithril.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:80,
		rarity:40,
	},
	mat_adamant:{
		name:"Chunk Adamant",
		icon:"6",
		desc:"A rock chunk containing adamantium.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:90,
		rarity:45,
	},
	mat_oridecon:{
		name:"Chunk Oridecon",
		icon:"5",
		desc:"A rock chunk containing oridecon.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:100,
		rarity:50,
	},
	mat_edril:{
		name:"Chunk Edril",
		icon:"gem26",
		desc:"A rock chunk containing oridecon.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:120,
		rarity:55,
	},
	mat_orichalcum:{
		name:"Chunk Orichalcum",
		icon:"9",
		desc:"A rock chunk containing orichalcum.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:140,
		rarity:60,
	},
	
	
	mat_log:{
		name:"Log",
		icon:"loot79",
		desc:"A log from a tree. Actually pretty heavy.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:10,
		rarity:15,
		
	},
	
	mat_scale:{
		name:"Scales",
		icon:"loot51",
		desc:"Some small, hard scales.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:10,
		rarity:15,
		
	},
	mat_largeScale:{
		name:"Large Scales",
		icon:"loot34",
		desc:"Some pretty large scales.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:30,
		rarity:25,
		
	},
	
	mat_fang:{
		name:"Fang",
		icon:"loot35",
		desc:"A big, sharp fang.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:30,
		rarity:15,
	},
	mat_claw:{
		name:"Claw",
		icon:"loot17",
		desc:"A sharp claw, taken from some animal.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:25,
		rarity:15,
	},
	
	mat_stickyLiquid:{
		name:"Sticky Liquid",
		icon:"loot7",
		desc:"A glob of some sticky liquid. Might actually be a good adhesive",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:35,
		rarity:15,
	},
	
	mat_fluff:{
		name:"Ball of Fluff",
		icon:"loot47",
		desc:"A ball of fluffy hair taken from an animal.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:10,
		rarity:15,
	},
	mat_mane:{
		name:"Mane",
		icon:"loot88",
		desc:"A la.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:10,
		rarity:15,
	},
	
	
	mat_fireCrystal:{
		name:"Fire Crystal",
		icon:"gem16",
		desc:"Crystal of fire.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:50,
		rarity:22,
	},
	mat_waterCrystal:{
		name:"Water Crystal",
		icon:"gem17",
		desc:"Crystal of water.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:50,
		rarity:22,
	},
	mat_airCrystal:{
		name:"Air Crystal",
		icon:"gem18",
		desc:"Crystal of air.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:50,
		rarity:22,
	},
	mat_earthCrystal:{
		name:"Earth Crystal",
		icon:"gem19",
		desc:"Crystal of earth.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:50,
		rarity:22,
	},
	
	mat_ruby:{
		name:"Raw Ruby",
		icon:"gem10",
		desc:"Raw, unenchanted ruby",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:100,
		rarity:25,
		
	},
	mat_sapphire:{
		name:"Raw Sapphire",
		icon:"gem11",
		desc:"Raw, unenchanted sapphire.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:100,
		rarity:25,
		
	},
	mat_diamond:{
		name:"Raw Diamond",
		icon:"gem12",
		desc:"Raw, unenchanted diamond.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:100,
		rarity:25,
		
	},
	mat_emerald:{
		name:"Raw Emerald",
		icon:"gem14",
		desc:"Raw, unenchanted emerald.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:100,
		rarity:25,
	},
	mat_topaz:{
		name:"Raw Topaz",
		icon:"gem13",
		desc:"Raw, unenchanted topaz.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:100,
		rarity:25,
	},
	mat_amythest:{
		name:"Raw Amythest",
		icon:"gem5",
		desc:"Raw, unenchanted amythest.",
		type:"Material",
		stacks:true,
		maxStack:0,
		
		value:100,
		rarity:25,
	},
	
	food_beer:{
		name:"Beer",
		icon:"food70",
		desc:"A mug frothing with ale",
		type:"Food",
		stacks:true,
		maxStack:0,
		
		value:5,
		rarity:5,
	},
	food_soda:{
		name:"Can of Soda",
		icon:"food70",
		desc:"An aluminum can filled with bubbling liquid",
		type:"Food",
		stacks:true,
		maxStack:0,
		
		value:5,
		rarity:5,
	},
	food_hamburger:{
		name:"Hamburger",
		icon:"food33",
		desc:"A nice beef patty stuck between two buns, with lettuce, tomato, and onions.",
		type:"Food",
		stacks:true,
		maxStack:0,
		
		value:15,
		rarity:5,
	},
	food_chiliDog:{
		name:"Chili Cheese Dog",
		icon:"food36",
		desc:"A sausage on a bun, smothered in chili and cheese.",
		type:"Food",
		stacks:true,
		maxStack:0,
		
		value:15,
		rarity:5,
	},
	
	cryst_lesserStr:{
		name:"Lesser Strength Crystal",
		icon:"gem5",
		desc:"Imbues a monster with a little bit of STR",
		type:"MonsterFood",
		stacks:true,
		maxStack:0,
		
		value:1000,
		rarity:22,
		
		str:1,
	},
	
}

//Copy ids into all items in the database
var itemNumber = 0;
for (var k in itemDB) { 
	itemDB[k]._id = k;
	itemDB[k].itemNumber = itemNumber;
	itemNumber += 1;
}

///Shop tabs
shop = {
	general: ["pot_red", "pot_red_elixer", "mat_iron", 
			 "cryst_lesser_str",],
}

///Drop datas
dropData = {
	standard: { type: "all", drops: [
		"equipment",
	]},
	template: { type: "all", drops:[
		{item: "a", 	chance: 0.00, qty: 1},
	]},
	elementalCrystals: { type: "all", drops:[
		{item: "mat_fireCrystal",	chance: 0.05, qty: 1},
		{item: "mat_airCrystal",	chance: 0.05, qty: 1},
		{item: "mat_waterCrystal",	chance: 0.05, qty: 1},
		{item: "mat_earthCrystal",	chance: 0.05, qty: 1},
	]},
	basicMats: { type: "all", drops:[
		{item: "mat_iron", 		chance: 0.05, qty: 40},
		{item: "mat_copper", 	chance: 0.05, qty: 40},
	]},
	rareGems: {type: "all", drops:[
		{item: "mat_ruby", 		chance: 0.01, qty: 1},
		{item: "mat_sapphire", 	chance: 0.01, qty: 1},
		{item: "mat_emerald", 	chance: 0.01, qty: 1},
		{item: "mat_topaz", 	chance: 0.01, qty: 1},
		{item: "mat_amythest", 	chance: 0.01, qty: 1},
		{item: "mat_diamond", 	chance: 0.01, qty: 1},
	]},
	equipment: { type: "one", drops: [
		{item: "meleeWeapon", 	chance: 0.20, qty: 1},
		{item: "heavyArmor", 	chance: 0.10, qty: 1},
		{item: "lightArmor", 	chance: 0.15, qty: 1},
	]},
}

///Roll a table of drops
///If 'rule' is a string, looks it up inside 'dropData'
///If 'rule' is an object, rolls it.
///Returns a results object of items, and how many to give.
rollDropTable = function(table) {
	var results = {};
	if (isArray(table)) {
		table.each((rule) => {
			doRoll(results, rule);
		});
	} else { 
		doRoll(results, table);
	}
	return results;
}


///Roll a table into a results object.
///Chooses from an array of drops
///Table: table of drops to roll
///table.drops (array of objects or strings) drops to roll.
///table.type (default "all")
///			"all" -> rolls for each object in 'drops'
///			"one" -> chooses one 'drops' and rolls it
function rollTable(results, table) {
	var type = table.xt("type", "all");
	var drops = table.drops;
	if (drops) {
		if (type == "one") {
			var roll = drops.choose();
			doRoll(results, roll);
		} else {
			drops.each((val)=>{
				doRoll(results, val);
			});
		}
	} else {
		console.log("Could not find drops in ")
		console.log(table)
	}
	
	return results;
}

///Roll a single roll into results
///roll is either a string or object
///		object -> object describes item to roll for (item, chance, qty)
///		string -> string describes another table to roll
function doRoll(results, roll) {
	if (isString(roll)) {
		var table = findTable(roll);
		if (table) { rollTable(results, table); }
	} else {
		var dropped = rollForDrops(roll);
		if (dropped > 0) { results[roll.item] = results.num(roll.item) + dropped; }
	}
	return results;
}

///Roll an object describing (item, chance, qty)
///		item -> item to roll for (used in calling function)
///		chance -> chance for each roll to succeed (0...1)
///		qty -> max drops from roll (1...inf)
function rollForDrops(roll) {
	if (roll.chance >= 1) { return roll.qty; }
	else if (roll.chance <= 0) { return 0; }
	
	var dropped = 0; var i;
	for (i = 0; i < roll.qty; i+=1) {
		if (Random.value() <= roll.chance) { dropped += 1; }
	}
	return dropped;
}

///Helper to find rule table
function findTable(rule) { 
	if (isString(rule)) { return dropData[rule]; }
	return null;
}



